<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Nearest Correlation Matrix · MvSim.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">MvSim.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">MvSim.jl</a></li><li><span class="tocitem">Guides</span><ul><li><a class="tocitem" href="../getting_started/">Getting Started</a></li><li><a class="tocitem" href="../pearson_matching/">Pearson Matching</a></li><li class="is-active"><a class="tocitem" href>Nearest Correlation Matrix</a><ul class="internal"><li><a class="tocitem" href="#Benchmarking"><span>Benchmarking</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../main_functions/">Main Functions</a></li><li><a class="tocitem" href="../utilities/">Utilities</a></li><li><a class="tocitem" href="../details/">Details</a></li><li><a class="tocitem" href="../function_index/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Guides</a></li><li class="is-active"><a href>Nearest Correlation Matrix</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Nearest Correlation Matrix</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/adknudson/MvSim.jl/blob/master/docs/src/nearest_correlation_matrix.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Nearest-Correlation-Matrix"><a class="docs-heading-anchor" href="#Nearest-Correlation-Matrix">Nearest Correlation Matrix</a><a id="Nearest-Correlation-Matrix-1"></a><a class="docs-heading-anchor-permalink" href="#Nearest-Correlation-Matrix" title="Permalink"></a></h1><p>Sometimes what we want really is the Spearman correlation. Then we don&#39;t need to do any Pearson matching. All we need to do is estimate/obtain the Spearman correlation of some data, convert it to Pearson, and then simulate. The resulting simulated data will have the same Spearman correlation as the one estimated from the data (up to stochastic error). The problem is that for high dimensional data, the Spearman or converted Pearson correlation matrix may not be positive semidefinite (PSD). The problem is then how to compute the nearest PSD correlation matrix.</p><p>We provide the function <code>cor_nearPD</code> to handle this problem. It is based off of the work of Qi and Sun (2006), and is a quadratically convergent algorithm. Here we use BRCA data to show its use.</p><pre><code class="language-julia-repl">julia&gt; m = Matrix(brca)
878×200 Array{Float64,2}:
      2.42686e6   47131.0        292717.0  …  93811.0   34168.0    1814.0
 719834.0        415707.0        338326.0     27934.0   41261.0   57961.0
      1.67475e6       1.52156e6  556783.0     91540.0   61890.0   85477.0
      1.14082e6  277162.0        380049.0     62468.0   30171.0   37379.0
 660487.0        504250.0        313120.0     34433.0   32450.0   44306.0
      1.37852e6       7.15225e6  796746.0  …  58779.0   46555.0   46230.0
 577958.0             2.1654e6   398694.0     25625.0   31330.0   20169.0
      1.0599e6   445787.0        496284.0     65047.0   38029.0   63358.0
      1.70653e6  177563.0        285268.0     93722.0  147704.0      37.0
      1.36036e6       2.21442e6  770635.0     64471.0   34574.0   77441.0
      ⋮                                    ⋱
 133177.0         35773.0         55143.0     18901.0   13591.0     126.0
 640157.0             1.44312e6  349451.0  …  26857.0   31804.0   52028.0
 760560.0        526643.0        402973.0     69531.0   24371.0   42206.0
 561799.0        147555.0        848469.0     47962.0   21519.0     333.0
 245867.0        224245.0        213969.0     34973.0   31067.0  123707.0
 633497.0        581455.0        692539.0     52434.0   22456.0    3441.0
 687263.0        163202.0        620491.0  …  34539.0   20698.0    3417.0
 946835.0        157578.0        287362.0     33074.0   69588.0   64613.0
 499893.0        238058.0        395895.0     33389.0   26519.0   37366.0

julia&gt; τ = cor(m, Spearman);

julia&gt; ρₚ = cor_convert(τ, Spearman, Pearson);

julia&gt; isposdef.([τ, ρₚ])
2-element BitArray{1}:
 1
 0</code></pre><p>We see that the converted Pearson correlation matrix is no longer positve definite. This will result in a failure during the multivariate normal generation, particularly during the Cholesky decomposition.</p><pre><code class="language-julia-repl">julia&gt; rvec(10, ρₚ, margins)
ERROR: PosDefException: matrix is not positive definite; Cholesky factorization failed.</code></pre><p>We can fix this by computing the nearest PD correlation.</p><pre><code class="language-julia-repl">julia&gt; ρ̃ₚ = cor_nearPD(ρₚ);

julia&gt; isposdef(ρ̃ₚ)
true

julia&gt; rvec(10, ρ̃ₚ, margins)
10×200 Array{Float64,2}:
 904919.0         59037.0        …  13069.0  35455.0  41412.0   15144.0
      1.05983e6  558366.0           32933.0  33237.0  50096.0   14597.0
      1.33868e6       1.30182e6     55734.0  91243.0  63634.0   17207.0
 865480.0        745158.0           68089.0  32764.0  46911.0  139473.0
 879271.0             1.03478e6     50097.0  33958.0  56051.0  204826.0
      1.36102e6  331767.0        …  54293.0  43699.0  31083.0    3661.0
      1.09496e6   36637.0           22377.0  19003.0  29131.0   11692.0
 776147.0             2.0496e6      52694.0  37666.0  39237.0   34146.0
      1.9304e6   201855.0           15408.0  77787.0  19350.0   43007.0
      1.94829e6  472741.0           72058.0  52017.0  37932.0    5924.0</code></pre><h2 id="Benchmarking"><a class="docs-heading-anchor" href="#Benchmarking">Benchmarking</a><a id="Benchmarking-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmarking" title="Permalink"></a></h2><p>What&#39;s more impressive is that computing the nearest correlation matrix in Julia is fast!</p><p>&lt;!– Benchmark hard coded because it&#39;s faster on my machine than the Travis servers –&gt;</p><pre><code class="language-julia">julia&gt; @benchmark cor_nearPD(ρₚ)
#&gt;BenchmarkTools.Trial: 
  memory estimate:  8.14 MiB
  allocs estimate:  160656
  --------------
  minimum time:     9.262 ms (0.00% GC)
  median time:      9.821 ms (0.00% GC)
  mean time:        11.853 ms (3.01% GC)
  maximum time:     73.566 ms (0.00% GC)
  --------------
  samples:          422
  evals/sample:     1</code></pre><p>Let&#39;s scale up to a larger correlation matrix:</p><pre><code class="language-julia-repl">julia&gt; m3000 = cor_randPSD(3000) |&gt; m -&gt; cor_convert(m, Spearman, Pearson)
3000×3000 Array{Float64,2}:
  1.0          -0.0111207    -0.0103037   …   0.0142703   -0.0313127
 -0.0111207     1.0           0.0387975       0.00608444  -0.000810933
 -0.0103037     0.0387975     1.0            -0.023768    -0.0101182
 -0.0428932    -0.00412804   -0.0275705       0.00966973   0.00207796
 -0.0292567     0.0238966     0.0235904       0.00362021  -0.0209776
  0.00833069    0.015135     -0.00144259  …  -0.0125061   -0.000288246
 -0.00723955    0.00609806    0.00601674      0.0343177   -0.033222
 -0.0294722    -0.0363295     0.0328225      -0.00654906  -0.0179531
 -0.0068601    -0.0101816    -0.0199614       0.0272806   -0.000443144
 -0.0356135     0.0242664     0.028273        0.0230136   -0.00592433
  ⋮                                       ⋱
  0.00597426    0.00487454    0.035151       -0.0175496   -0.0153092
 -0.00184964   -0.0139413     0.00731895      0.0126292   -0.00516432
 -0.00432519   -0.0367523    -0.00951619     -0.00311527  -0.00590312
  0.00926152   -0.0223976    -0.0175765       0.0278087   -0.0154935
  0.000845635   0.00619016   -0.00435605  …  -0.0093515   -0.00182161
 -0.0313517    -0.0113531     0.026965       -0.0355385    0.00398532
 -0.0294769    -0.0194167    -0.00326993     -0.0121536   -0.00571171
  0.0142703     0.00608444   -0.023768        1.0         -0.00379341
 -0.0313127    -0.000810933  -0.0101182      -0.00379341   1.0

julia&gt; m3000_PD = cor_nearPD(m3000);

julia&gt; isposdef(m3000)
false

julia&gt; isposdef(m3000_PD)
true</code></pre><p>&lt;!– Benchmark hard coded because it&#39;s faster on my machine than the Travis servers –&gt;</p><pre><code class="language-julia">julia&gt; @benchmark cor_nearPD(m3000)
#&gt;BenchmarkTools.Trial: 
  memory estimate:  1.09 GiB
  allocs estimate:  26089
  --------------
  minimum time:     2.388 s (1.71% GC)
  median time:      2.477 s (3.24% GC)
  mean time:        2.470 s (3.89% GC)
  maximum time:     2.544 s (6.57% GC)
  --------------
  samples:          3
  evals/sample:     1</code></pre><p>~3 seconds to convert a 3000x3000 correlation matrix! This even beats previous benchmarks for a 3000x3000 randomly generated pseudo correlation matrix. Here is an excert from Defeng Sun&#39;s home page where his matlab code is:</p><blockquote><p>For a randomly generated  3,000 by 3,000 pseudo correlation matrix (the code is insensitive to input data), the code needs 24 seconds to reach a solution with the relative duality gap less than 1.0e-3 after 3 iterations and 43 seconds  with the relative duality gap less than 1.0e-10 after 6 iterations in my Dell Desktop with Intel (R) Core i7 processor.</p></blockquote></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../pearson_matching/">« Pearson Matching</a><a class="docs-footer-nextpage" href="../main_functions/">Main Functions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 5 January 2021 23:23">Tuesday 5 January 2021</span>. Using Julia version 1.5.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
