<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Nearest Correlation Matrix · MvSim.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">MvSim.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">MvSim.jl</a></li><li><span class="tocitem">Guides</span><ul><li><a class="tocitem" href="../getting_started/">Getting Started</a></li><li><a class="tocitem" href="../pearson_matching/">Pearson Matching</a></li><li class="is-active"><a class="tocitem" href>Nearest Correlation Matrix</a><ul class="internal"><li><a class="tocitem" href="#Benchmarking"><span>Benchmarking</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../main_functions/">Main Functions</a></li><li><a class="tocitem" href="../utilities/">Utilities</a></li><li><a class="tocitem" href="../details/">Details</a></li><li><a class="tocitem" href="../function_index/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Guides</a></li><li class="is-active"><a href>Nearest Correlation Matrix</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Nearest Correlation Matrix</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/adknudson/MvSim.jl/blob/master/docs/src/nearest_correlation_matrix.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Nearest-Correlation-Matrix"><a class="docs-heading-anchor" href="#Nearest-Correlation-Matrix">Nearest Correlation Matrix</a><a id="Nearest-Correlation-Matrix-1"></a><a class="docs-heading-anchor-permalink" href="#Nearest-Correlation-Matrix" title="Permalink"></a></h1><p>Sometimes what we want really is the Spearman correlation. Then we don&#39;t need to do any Pearson matching. All we need to do is estimate/obtain the Spearman correlation of some data, convert it to Pearson, and then simulate. The resulting simulated data will have the same Spearman correlation as the one estimated from the data (up to stochastic error). The problem is that for high dimensional data, the Spearman or converted Pearson correlation matrix may not be positive semidefinite (PSD). The problem is then how to compute the nearest PSD correlation matrix.</p><p>We provide the function <code>cor_nearPD</code> to handle this problem. It is based off of the work of Qi and Sun (2006), and is a quadratically convergent algorithm. Here we use BRCA data to show its use.</p><pre><code class="language-julia-repl">julia&gt; m = Matrix(brca)
878×200 Array{Float64,2}:
      2.42686e6   47131.0        292717.0  …  93811.0   34168.0    1814.0
 719834.0        415707.0        338326.0     27934.0   41261.0   57961.0
      1.67475e6       1.52156e6  556783.0     91540.0   61890.0   85477.0
      1.14082e6  277162.0        380049.0     62468.0   30171.0   37379.0
 660487.0        504250.0        313120.0     34433.0   32450.0   44306.0
      1.37852e6       7.15225e6  796746.0  …  58779.0   46555.0   46230.0
 577958.0             2.1654e6   398694.0     25625.0   31330.0   20169.0
      1.0599e6   445787.0        496284.0     65047.0   38029.0   63358.0
      1.70653e6  177563.0        285268.0     93722.0  147704.0      37.0
      1.36036e6       2.21442e6  770635.0     64471.0   34574.0   77441.0
      ⋮                                    ⋱
 133177.0         35773.0         55143.0     18901.0   13591.0     126.0
 640157.0             1.44312e6  349451.0  …  26857.0   31804.0   52028.0
 760560.0        526643.0        402973.0     69531.0   24371.0   42206.0
 561799.0        147555.0        848469.0     47962.0   21519.0     333.0
 245867.0        224245.0        213969.0     34973.0   31067.0  123707.0
 633497.0        581455.0        692539.0     52434.0   22456.0    3441.0
 687263.0        163202.0        620491.0  …  34539.0   20698.0    3417.0
 946835.0        157578.0        287362.0     33074.0   69588.0   64613.0
 499893.0        238058.0        395895.0     33389.0   26519.0   37366.0

julia&gt; τ = cor(m, Spearman);

julia&gt; ρₚ = cor_convert(τ, Spearman, Pearson);

julia&gt; isposdef.([τ, ρₚ])
2-element BitArray{1}:
 1
 0</code></pre><p>We see that the converted Pearson correlation matrix is no longer positve definite. This will result in a failure during the multivariate normal generation, particularly during the Cholesky decomposition.</p><pre><code class="language-julia-repl">julia&gt; rvec(10, ρₚ, margins)
ERROR: PosDefException: matrix is not positive definite; Cholesky factorization failed.</code></pre><p>We can fix this by computing the nearest PD correlation.</p><pre><code class="language-julia-repl">julia&gt; ρ̃ₚ = cor_nearPD(ρₚ);

julia&gt; isposdef(ρ̃ₚ)
true

julia&gt; rvec(10, ρ̃ₚ, margins)
10×200 Array{Float64,2}:
      2.16091e6  463378.0  180183.0  259790.0  …  106833.0  36595.0  181663.0
      1.03568e6  260651.0  535314.0  115807.0      86663.0  41094.0   87882.0
      1.05657e6   10409.0  313948.0   27116.0      37934.0  70458.0    9674.0
      2.16519e6  149297.0  338935.0  301125.0      64565.0  51555.0   19024.0
      1.46955e6  278227.0  366991.0  175037.0      44928.0  31433.0   59437.0
      1.59833e6  229345.0  393393.0  196285.0  …   69936.0  69901.0   77491.0
 626822.0        630426.0  654058.0  693653.0      52230.0  35768.0   13530.0
 842028.0        564584.0  250223.0  525089.0      46428.0  35700.0   34736.0
      1.06693e6  180266.0  379330.0  252493.0      35669.0  49068.0   31194.0
      1.27309e6  933322.0  441176.0  696513.0      84360.0  50568.0   47325.0</code></pre><h2 id="Benchmarking"><a class="docs-heading-anchor" href="#Benchmarking">Benchmarking</a><a id="Benchmarking-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmarking" title="Permalink"></a></h2><p>What&#39;s more impressive is that computing the nearest correlation matrix in Julia is fast!</p><pre><code class="language-julia-repl">julia&gt; @benchmark cor_nearPD(ρₚ)
BenchmarkTools.Trial:
  memory estimate:  8.07 MiB
  allocs estimate:  160654
  --------------
  minimum time:     24.495 ms (0.00% GC)
  median time:      28.135 ms (0.00% GC)
  mean time:        30.051 ms (6.59% GC)
  maximum time:     45.119 ms (36.42% GC)
  --------------
  samples:          167
  evals/sample:     1</code></pre><p>Let&#39;s scale up to a larger correlation matrix:</p><pre><code class="language-julia-repl">julia&gt; m3000 = cor_randPSD(3000) |&gt; m -&gt; cor_convert(m, Spearman, Pearson)
3000×3000 Array{Float64,2}:
  1.0          0.0126476   -0.00593473   …   0.0277648    0.00594801
  0.0126476    1.0         -0.0202296       -0.0263159    0.0052947
 -0.00593473  -0.0202296    1.0             -0.0178631    0.000842581
 -0.0159055    0.00568993   0.0130412       -0.00419132   0.0108019
  0.0416436   -0.00700373   0.0130314       -0.00658486   0.0212246
  0.00016545   0.0285447    0.0107058    …  -0.0140993   -0.0364264
 -0.0251207    0.00540884  -0.0265637       -0.023878    -0.00279528
 -0.00458785  -0.00417301  -0.00366784       0.0242059    0.00610596
  0.00379684  -0.0141055    0.00575027      -0.0024411   -0.0102362
  0.0163524    0.0250324   -0.0143592       -0.0198795    0.0111897
  ⋮                                      ⋱
 -0.00529432   0.0220104    0.0140734        0.0226193   -0.00856761
 -0.00969834   0.0199059   -0.0185239       -0.0352483    5.0912e-5
 -0.00797792  -0.00671637  -0.0183291        0.015286    -0.0107774
 -0.00042454  -0.0363433    0.0327147        0.00573655   0.0052227
 -0.0232892   -0.0174613    0.0158757    …   0.0119779    0.0245159
 -0.0176696   -0.0316833    0.0349293        0.0107883   -0.0405969
  0.0202042   -0.0262321   -0.00483658      -0.0163566    0.00430848
  0.0277648   -0.0263159   -0.0178631        1.0         -0.0131157
  0.00594801   0.0052947    0.000842581     -0.0131157    1.0

julia&gt; m3000_PD = cor_nearPD(m3000);

julia&gt; isposdef(m3000)
false

julia&gt; isposdef(m3000_PD)
true

julia&gt; @benchmark cor_nearPD(m3000)
BenchmarkTools.Trial:
  memory estimate:  1.09 GiB
  allocs estimate:  26089
  --------------
  minimum time:     9.706 s (1.25% GC)
  median time:      9.706 s (1.25% GC)
  mean time:        9.706 s (1.25% GC)
  maximum time:     9.706 s (1.25% GC)
  --------------
  samples:          1
  evals/sample:     1</code></pre><p>~3 seconds to convert a 3000x3000 correlation matrix! This even beats previous benchmarks for a 3000x3000 randomly generated pseudo correlation matrix. Here is an excert from Defeng Sun&#39;s home page where his matlab code is:</p><blockquote><p>For a randomly generated  3,000 by 3,000 pseudo correlation matrix (the code is insensitive to input data), the code needs 24 seconds to reach a solution with the relative duality gap less than 1.0e-3 after 3 iterations and 43 seconds  with the relative duality gap less than 1.0e-10 after 6 iterations in my Dell Desktop with Intel (R) Core i7 processor.</p></blockquote></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../pearson_matching/">« Pearson Matching</a><a class="docs-footer-nextpage" href="../main_functions/">Main Functions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 30 December 2020 21:55">Wednesday 30 December 2020</span>. Using Julia version 1.5.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
