<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Nearest Correlation Matrix · bigsimr.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">bigsimr.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">bigsimr.jl</a></li><li><span class="tocitem">Guides</span><ul><li><a class="tocitem" href="../getting_started/">Getting Started</a></li><li><a class="tocitem" href="../pearson_matching/">Pearson Matching</a></li><li class="is-active"><a class="tocitem" href>Nearest Correlation Matrix</a><ul class="internal"><li><a class="tocitem" href="#Benchmarking"><span>Benchmarking</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../main_functions/">Main Functions</a></li><li><a class="tocitem" href="../utilities/">Utilities</a></li><li><a class="tocitem" href="../details/">Details</a></li><li><a class="tocitem" href="../function_index/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Guides</a></li><li class="is-active"><a href>Nearest Correlation Matrix</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Nearest Correlation Matrix</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/adknudson/bigsimr.jl/blob/master/docs/src/nearest_correlation_matrix.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Nearest-Correlation-Matrix"><a class="docs-heading-anchor" href="#Nearest-Correlation-Matrix">Nearest Correlation Matrix</a><a id="Nearest-Correlation-Matrix-1"></a><a class="docs-heading-anchor-permalink" href="#Nearest-Correlation-Matrix" title="Permalink"></a></h1><p>Sometimes what we want really is the Spearman correlation. Then we don&#39;t need to do any Pearson matching. All we need to do is estimate/obtain the Spearman correlation of some data, convert it to Pearson, and then simulate. The resulting simulated data will have the same Spearman correlation as the one estimated from the data (up to stochastic error). The problem is that for high dimensional data, the Spearman or converted Pearson correlation matrix may not be positive semidefinite (PSD). The problem is then how to compute the nearest PSD correlation matrix.</p><p>We provide the function <code>cor_nearPD</code> to handle this problem. It is based off of the work of Qi and Sun (2006), and is a quadratically convergent algorithm. Here we use BRCA data to show its use.</p><pre><code class="language-julia-repl">julia&gt; m = Matrix(brca)
878×200 Array{Float64,2}:
      2.42686e6   47131.0        292717.0  …  93811.0   34168.0    1814.0
 719834.0        415707.0        338326.0     27934.0   41261.0   57961.0
      1.67475e6       1.52156e6  556783.0     91540.0   61890.0   85477.0
      1.14082e6  277162.0        380049.0     62468.0   30171.0   37379.0
 660487.0        504250.0        313120.0     34433.0   32450.0   44306.0
      1.37852e6       7.15225e6  796746.0  …  58779.0   46555.0   46230.0
 577958.0             2.1654e6   398694.0     25625.0   31330.0   20169.0
      1.0599e6   445787.0        496284.0     65047.0   38029.0   63358.0
      1.70653e6  177563.0        285268.0     93722.0  147704.0      37.0
      1.36036e6       2.21442e6  770635.0     64471.0   34574.0   77441.0
      ⋮                                    ⋱
 133177.0         35773.0         55143.0     18901.0   13591.0     126.0
 640157.0             1.44312e6  349451.0  …  26857.0   31804.0   52028.0
 760560.0        526643.0        402973.0     69531.0   24371.0   42206.0
 561799.0        147555.0        848469.0     47962.0   21519.0     333.0
 245867.0        224245.0        213969.0     34973.0   31067.0  123707.0
 633497.0        581455.0        692539.0     52434.0   22456.0    3441.0
 687263.0        163202.0        620491.0  …  34539.0   20698.0    3417.0
 946835.0        157578.0        287362.0     33074.0   69588.0   64613.0
 499893.0        238058.0        395895.0     33389.0   26519.0   37366.0

julia&gt; τ = cor(m, Spearman);

julia&gt; ρₚ = cor_convert(τ, Spearman, Pearson);

julia&gt; isposdef.([τ, ρₚ])
2-element BitArray{1}:
 1
 0</code></pre><p>We see that the converted Pearson correlation matrix is no longer positve definite. This will result in a failure during the multivariate normal generation, particularly during the Cholesky decomposition.</p><pre><code class="language-julia-repl">julia&gt; rvec(10, ρₚ, margins)
ERROR: bigsimr.ValidCorrelationError()</code></pre><p>We can fix this by computing the nearest PD correlation.</p><pre><code class="language-julia-repl">julia&gt; ρ̃ₚ = cor_nearPD(ρₚ);

julia&gt; isposdef(ρ̃ₚ)
true

julia&gt; rvec(10, ρ̃ₚ, margins)
10×200 Array{Float64,2}:
      1.27021e6  742112.0        …  43940.0   52966.0  40802.0  37145.0
      1.31482e6  182152.0           34944.0   41393.0  44512.0  68910.0
      2.09568e6  420648.0           50660.0   67492.0  58517.0   1514.0
 805438.0             1.30537e6     36169.0   14313.0  31030.0  53970.0
      2.13561e6  352285.0           62586.0  149686.0  38647.0  25964.0
 788844.0         13307.0        …  37550.0   21298.0  18427.0  21670.0
 614132.0        803915.0           87815.0   83708.0  36921.0  31407.0
      1.97914e6       2.59886e6     90096.0   83475.0  71733.0  95775.0
      1.15013e6  254605.0           47620.0   47450.0  30863.0  29454.0
 841409.0         38792.0           20695.0   55768.0  39661.0   6149.0</code></pre><h2 id="Benchmarking"><a class="docs-heading-anchor" href="#Benchmarking">Benchmarking</a><a id="Benchmarking-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmarking" title="Permalink"></a></h2><p>What&#39;s more impressive is that computing the nearest correlation matrix in Julia is fast!</p><pre><code class="language-julia-repl">julia&gt; @benchmark cor_nearPD(ρₚ)
BenchmarkTools.Trial: 
  memory estimate:  6.84 MiB
  allocs estimate:  160652
  --------------
  minimum time:     8.485 ms (0.00% GC)
  median time:      8.848 ms (0.00% GC)
  mean time:        9.326 ms (4.77% GC)
  maximum time:     13.108 ms (0.00% GC)
  --------------
  samples:          537
  evals/sample:     1</code></pre><p>Let&#39;s scale up to a larger correlation matrix:</p><pre><code class="language-julia-repl">julia&gt; m3000 = cor_randPSD(3000) |&gt; m -&gt; cor_convert(m, Spearman, Pearson)
3000×3000 Array{Float64,2}:
  1.0          0.00995828   -0.0203918    …   0.00106645  -0.0188615
  0.00995828   1.0           0.00152212      -0.0355465   -0.00502137
 -0.0203918    0.00152212    1.0             -0.00403786  -0.0182917
  0.0157591    0.00869354    0.000761101      0.0132537   -0.00396654
  0.00197951  -0.0086881    -0.0362671       -0.0194822   -0.0214476
 -0.00964459   0.0201845    -0.0123357    …   0.00392737  -0.0025949
  0.0139432   -0.0286031     0.0264459        0.0108863    0.0158744
 -0.0185428   -0.00422123   -0.00524792       0.00334076  -0.0115717
 -0.00977969   0.00701174   -0.0265965       -0.0211022   -0.000438425
  0.0323123   -0.0133116     0.00964085      -0.0295789   -0.0165751
  ⋮                                       ⋱
 -0.00205194   0.000599556  -0.0248223        0.0016605   -0.00617049
  0.00544502   0.0296478     0.00656525      -0.00558353  -0.000437325
 -0.0011039    0.01379       0.0272283        0.010801    -0.0122611
  0.0104618    0.0201228     0.0121996        0.00111602  -0.00162734
 -0.0208613   -0.0203671    -0.0167255    …  -0.045328     0.0282737
 -0.0314179   -0.019832     -0.0347877        0.0234211   -0.00742692
  0.0170428    0.0201636    -0.0221612        0.00626349  -0.00173449
  0.00106645  -0.0355465    -0.00403786       1.0          0.00303902
 -0.0188615   -0.00502137   -0.0182917        0.00303902   1.0

julia&gt; m3000_PD = cor_nearPD(m3000);

julia&gt; isposdef(m3000)
false

julia&gt; isposdef(m3000_PD)
true</code></pre><pre><code class="language-julia-repl">julia&gt; @benchmark cor_nearPD(m3000)
BenchmarkTools.Trial: 
  memory estimate:  3.72 GiB
  allocs estimate:  78433
  --------------
  minimum time:     11.460 s (2.31% GC)
  median time:      11.460 s (2.31% GC)
  mean time:        11.460 s (2.31% GC)
  maximum time:     11.460 s (2.31% GC)
  --------------
  samples:          1
  evals/sample:     1</code></pre><p>~12 seconds to convert a 3000x3000 correlation matrix! This even beats previous benchmarks for a 3000x3000 randomly generated pseudo correlation matrix. Here is an excert from Defeng Sun&#39;s home page where his matlab code is:</p><blockquote><p>For a randomly generated  3,000 by 3,000 pseudo correlation matrix (the code is insensitive to input data), the code needs 24 seconds to reach a solution with the relative duality gap less than 1.0e-3 after 3 iterations and 43 seconds  with the relative duality gap less than 1.0e-10 after 6 iterations in my Dell Desktop with Intel (R) Core i7 processor.</p></blockquote><p>We also offer a faster routine that gives up a little accuracy for speed. While <a href="../main_functions/#bigsimr.cor_nearPD"><code>cor_nearPD</code></a> finds the nearest correlation matrix to the input matrix, <a href="../main_functions/#bigsimr.cor_fastPD"><code>cor_fastPD</code></a> finds a positive definite correlation matrix that is <em>close</em> to the input matrix.</p><pre><code class="language-julia-repl">julia&gt; @benchmark cor_fastPD(m3000)
BenchmarkTools.Trial: 
  memory estimate:  628.95 MiB
  allocs estimate:  26035
  --------------
  minimum time:     2.037 s (0.58% GC)
  median time:      2.093 s (1.75% GC)
  mean time:        2.115 s (3.38% GC)
  maximum time:     2.216 s (7.49% GC)
  --------------
  samples:          3
  evals/sample:     1</code></pre><p>And it&#39;s not too far off from the nearest:</p><pre><code class="language-julia-repl">julia&gt; m3000_PD_fast = cor_fastPD(m3000);

julia&gt; norm(m3000 - m3000_PD)
0.7323327989204529

julia&gt; norm(m3000 - m3000_PD_fast)
0.7650420681857858</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../pearson_matching/">« Pearson Matching</a><a class="docs-footer-nextpage" href="../main_functions/">Main Functions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 9 February 2021 22:20">Tuesday 9 February 2021</span>. Using Julia version 1.5.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
